# Cтруктура файлов

<img width="138" alt="image" src="https://user-images.githubusercontent.com/77805226/165472617-392d9f9c-adaa-4dce-9cdb-180183f3f998.png">


## Общая информация о файлах
В основной (корневой) модуль (в main.tf) подключаются два дополнительных: для разворачивания зонального и регионального кластеров.
В файлах data.tf прописаны соответствующие datasource-ы. Про них можно подробнее прочитать здесь: https://www.terraform.io/language/data-sources
В файлах outputs.tf прописаны соответствующие output values для наглядного отображения информации о кластере. Про них можно подробнее прочитать здесь: https://www.terraform.io/language/values/outputs
Файлы provider.tf определяют необходимых провайдеров для возможности последующего создания ресурсов.
Файлы sg.tf определяют группы безопасности, которые впоследствии применяются на нод-группы в файлах k8s.tf и k8s_zonal.tf.


## Особенности и логика внутри файлов
Основная мысль использования данного подхода заключается в том, чтобы вынести как можно больше существенных параметров, которые определяют инфраструктуру, в файлы variables.tf.
Это предоставляет возможность пользователю не заглядывать в основные файлы и не задумываться о логике внутри.
При этом был соблюден баланс, и было принято решение оставить часть высокоуровневых параметров (таких как: версия, релизный канал, платформа, container runtime и дефолтная зона) в main.tf.
Также это было сделано для наглядности (чтобы понимать, какой кластер в итоге мы разворачиваем).
В файлах variables.tf, помимо рядового определения переменных, используются абстракции над числами.
То есть, нет необходимости определять значения числовых параметров (хотя при желани можно поменять значения данных параметров в variables) типа memory, cores, core_fraction, gpus, size.
Это уже реализовано посредством terraform conditionals + map variables. 
Подробнее об этом здесь: https://www.terraform.io/language/expressions/conditionals и https://www.terraform.io/language/configuration-0-11/variables
Определение каждого параметра в variables снабжено подробным комментарием по его использованию.
Использование контроллера сетевых политик определено в основных файлах (k8s.tf и k8s_zonal.tf). По умолчанию используется calico, но это можно изменить, раскомментировав блок с network implementation {cilium {} } и закомментировав блок с network_policy_provider="CALICO".
В файлах sg.tf используются динамические блоки для определения списка портов для групп безопасности. 
Подробнее о динамических блоках здесь: https://www.terraform.io/language/expressions/dynamic-blocks


### Сценарий: хочу развернуть только региональный или только зональный кластер
Чтобы использовать один из них, достаточно закомментировать в файле main.tf необходимый блок.
Далее нужно определить переменные в файле variables.tf (в необходимом для вас модуле).
После этого определить параметры в файле main.tf.


### Сценарий: хочу развернуть и региональный, и зональный кластер
Оставить файл main.tf в том состоянии, в котором он есть, поменяв лишь необходимые параметры на нужные значения.
Далее нужно определить переменные в файлах variables.tf (во всех необходимых вам модулях).


### Сценарий: хочу модифицировать значения для кластеров, которые используются по умолчанию
В файлах variables.tf изменить значения default_having_size, default_having_memory, default_having_cores, default_having_core_fraction, default_having_gpu.
